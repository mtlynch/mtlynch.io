{{- $project := .Get "project" -}}

{{- /* Extract year and month from page URL */ -}}
{{- $permalink := .Page.RelPermalink -}}
{{- /* Expected format: /retrospectives/YYYY/MM/ */ -}}
{{- $pathParts := split $permalink "/" -}}
{{- $year := "" -}}
{{- $month := "" -}}

{{- /* Find retrospectives, year, and month in the path */ -}}
{{- range $i, $part := $pathParts -}}
  {{- if eq $part "retrospectives" -}}
    {{- if gt (len $pathParts) (add $i 2) -}}
      {{- $year = index $pathParts (add $i 1) -}}
      {{- $month = index $pathParts (add $i 2) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* Early return: Check if year and month were extracted */ -}}
{{- if not (and $year $month) -}}
  {{- errorf
    "Could not extract year and month from URL: %s. Expected format: /retrospectives/YYYY/MM/. Path parts: %s"
    $permalink
    $pathParts
  -}}
{{- end -}}

{{- /* Early return: Validate year and month format */ -}}
{{- $yearInt := int $year -}}
{{- $monthInt := int (strings.TrimLeft "0" $month) -}}
{{- if not (and
  (ge $yearInt 2000)
  (le $yearInt 3000)
  (ge $monthInt 1)
  (le $monthInt 12)
) -}}
  {{- errorf
    "Invalid year (%s) or month (%s) extracted from URL: %s. Year must be 2000-3000, month must be 1-12."
    $year
    $month
    $permalink
  -}}
{{- end -}}

{{- /* Create a time object for the retrospective date and calculate previous months using Go's time functions */ -}}
{{- $retroDate := time (printf "%d-%02d-01" $yearInt $monthInt) -}}
{{- $currentDate := $retroDate.AddDate 0 -1 0 -}}
{{- $prevDate := $retroDate.AddDate 0 -2 0 -}}

{{- $data := index .Site.Data "project_metrics" -}}
{{- $projectData := index $data $project -}}

{{- /* Prepare data for the chart */ -}}
{{- $chartData := slice -}}
{{- $chartLabels := slice -}}
{{- range $dateKey, $monthData := $projectData -}}
  {{- $dateObj := time (printf "%s-01" $dateKey) -}}
  {{- if le $dateObj $currentDate -}}
    {{- $totalRevenue := add
      (add
        ($monthData.revenue_pre_orders | default 0.0 | float)
        ($monthData.revenue_consulting | default 0.0 | float)
      )
      ($monthData.revenue_sponsors | default 0.0 | float)
    -}}
    {{- $chartData = $chartData | append (dict
      "date" $dateKey
      "visitors" ($monthData.unique_visitors | default 0 | int)
      "revenue" $totalRevenue
    ) -}}
    {{- $chartLabels = $chartLabels | append ($dateObj.Format "Jan 2006") -}}
  {{- end -}}
{{- end -}}

{{- /* Sort the data by date */ -}}
{{- $sortedData := sort $chartData "date" -}}
{{- $sortedLabels := slice -}}
{{- $visitorsData := slice -}}
{{- $revenueData := slice -}}
{{- range $sortedData -}}
  {{- $dateObj := time (printf "%s-01" .date) -}}
  {{- $sortedLabels = $sortedLabels | append ($dateObj.Format "Jan 2006") -}}
  {{- $visitorsData = $visitorsData | append .visitors -}}
  {{- $revenueData = $revenueData | append .revenue -}}
{{- end -}}

{{- partial "project-metrics/graph.html" (dict
  "project" $project
  "sortedLabels" $sortedLabels
  "visitorsData" $visitorsData
  "revenueData" $revenueData
) -}}

{{- partial "project-metrics/table.html" (dict
  "project" $project
  "projectData" $projectData
  "prevDate" $prevDate
  "currentDate" $currentDate
) -}}
