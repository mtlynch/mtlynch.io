{{- $project := .Get "project" -}}

{{- /* Extract year and month from page URL */ -}}
{{- $permalink := .Page.RelPermalink -}}
{{- /* Expected format: /retrospectives/YYYY/MM/ */ -}}
{{- $pathParts := split $permalink "/" -}}
{{- $year := "" -}}
{{- $month := "" -}}

{{- /* Find retrospectives, year, and month in the path */ -}}
{{- range $i, $part := $pathParts -}}
  {{- if eq $part "retrospectives" -}}
    {{- if gt (len $pathParts) (add $i 2) -}}
      {{- $year = index $pathParts (add $i 1) -}}
      {{- $month = index $pathParts (add $i 2) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* Early return: Check if year and month were extracted */ -}}
{{- if not (and $year $month) -}}
  {{- errorf
    "Could not extract year and month from URL: %s. Expected format: /retrospectives/YYYY/MM/. Path parts: %s"
    $permalink
    $pathParts
  -}}
{{- end -}}

{{- /* Early return: Validate year and month format */ -}}
{{- $yearInt := int $year -}}
{{- $monthInt := int (strings.TrimLeft "0" $month) -}}
{{- if not (and
  (ge $yearInt 2000)
  (le $yearInt 3000)
  (ge $monthInt 1)
  (le $monthInt 12)
) -}}
  {{- errorf
    "Invalid year (%s) or month (%s) extracted from URL: %s. Year must be 2000-3000, month must be 1-12."
    $year
    $month
    $permalink
  -}}
{{- end -}}

{{- /* Create a time object for the retrospective date and calculate previous months using Go's time functions */ -}}
{{- $retroDate := time (printf "%d-%02d-01" $yearInt $monthInt) -}}
{{- $currentDate := $retroDate.AddDate 0 -1 0 -}}
{{- $prevDate := $retroDate.AddDate 0 -2 0 -}}
{{- $current := $currentDate.Format "2006-01" -}}
{{- $prev := $prevDate.Format "2006-01" -}}

{{- $data := index .Site.Data "project_metrics" -}}
{{- $projectData := index $data $project -}}
{{- $prevData := index $projectData $prev -}}
{{- $currentData := index $projectData $current -}}

{{- /* Early return: Check if data exists for both months */ -}}
{{- if not (and $prevData $currentData) -}}
  {{- errorf
    "Could not find data for project \"%s\" with months \"%s\" and \"%s\". Available data: %s"
    $project
    $prev
    $current
    $projectData
  -}}
{{- end -}}

{{- /* Calculate unique visitors values */ -}}
{{- $prevUniqueVisitors := $prevData.unique_visitors | default 0 | int -}}
{{- $currentUniqueVisitors := $currentData.unique_visitors | default 0 | int -}}

{{- /* Calculate revenue values */ -}}
{{- $prevPreOrders := $prevData.revenue_pre_orders | default 0.0 | float -}}
{{- $prevConsulting := $prevData.revenue_consulting | default 0.0 | float -}}
{{- $prevSponsors := $prevData.revenue_sponsors | default 0.0 | float -}}
{{- $prevTotal := add (add $prevPreOrders $prevConsulting) $prevSponsors -}}

{{- $currentPreOrders := $currentData.revenue_pre_orders | default 0.0 | float -}}
{{- $currentConsulting := $currentData.revenue_consulting | default 0.0 | float -}}
{{- $currentSponsors := $currentData.revenue_sponsors | default 0.0 | float -}}
{{- $currentTotal := add (add $currentPreOrders $currentConsulting) $currentSponsors -}}

{{- /* Calculate changes */ -}}
{{- $uniqueVisitorsChange := sub $currentUniqueVisitors $prevUniqueVisitors -}}
{{- $preOrdersChange := sub $currentPreOrders $prevPreOrders -}}
{{- $consultingChange := sub $currentConsulting $prevConsulting -}}
{{- $sponsorsChange := sub $currentSponsors $prevSponsors -}}
{{- $totalChange := sub $currentTotal $prevTotal -}}

{{- /* Calculate percentage changes */ -}}
{{- $uniqueVisitorsPercent := 0.0 -}}
{{- if gt $prevUniqueVisitors 0 -}}
  {{- $uniqueVisitorsPercent = div
    (mul (float $uniqueVisitorsChange) 100.0)
    (float $prevUniqueVisitors)
  -}}
{{- end -}}

{{- $preOrdersPercent := 0.0 -}}
{{- if gt $prevPreOrders 0 -}}
  {{- $preOrdersPercent = div (mul $preOrdersChange 100) $prevPreOrders -}}
{{- end -}}

{{- $consultingPercent := 0.0 -}}
{{- if gt $prevConsulting 0 -}}
  {{- $consultingPercent = div (mul $consultingChange 100) $prevConsulting -}}
{{- end -}}

{{- $sponsorsPercent := 0.0 -}}
{{- if gt $prevSponsors 0 -}}
  {{- $sponsorsPercent = div (mul $sponsorsChange 100) $prevSponsors -}}
{{- end -}}

{{- $totalPercent := 0.0 -}}
{{- if gt $prevTotal 0 -}}
  {{- $totalPercent = div (mul $totalChange 100) $prevTotal -}}
{{- end -}}

{{- /* Generate month names using Go's time formatting from the time objects we already created */ -}}
{{- $prevMonth := $prevDate.Format "January 2006" -}}
{{- $currentMonth := $currentDate.Format "January 2006" -}}

{{- /* Prepare data for the chart */ -}}
{{- $chartData := slice -}}
{{- $chartLabels := slice -}}
{{- range $dateKey, $monthData := $projectData -}}
  {{- $dateObj := time (printf "%s-01" $dateKey) -}}
  {{- if le $dateObj $currentDate -}}
    {{- $totalRevenue := add
      (add
        ($monthData.revenue_pre_orders | default 0.0 | float)
        ($monthData.revenue_consulting | default 0.0 | float)
      )
      ($monthData.revenue_sponsors | default 0.0 | float)
    -}}
    {{- $chartData = $chartData | append (dict
      "date" $dateKey
      "visitors" ($monthData.unique_visitors | default 0 | int)
      "revenue" $totalRevenue
    ) -}}
    {{- $chartLabels = $chartLabels | append ($dateObj.Format "Jan 2006") -}}
  {{- end -}}
{{- end -}}

{{- /* Sort the data by date */ -}}
{{- $sortedData := sort $chartData "date" -}}
{{- $sortedLabels := slice -}}
{{- $visitorsData := slice -}}
{{- $revenueData := slice -}}
{{- range $sortedData -}}
  {{- $dateObj := time (printf "%s-01" .date) -}}
  {{- $sortedLabels = $sortedLabels | append ($dateObj.Format "Jan 2006") -}}
  {{- $visitorsData = $visitorsData | append .visitors -}}
  {{- $revenueData = $revenueData | append .revenue -}}
{{- end -}}

{{- partial "project-metrics/graph.html" (dict
  "project" $project
  "sortedLabels" $sortedLabels
  "visitorsData" $visitorsData
  "revenueData" $revenueData
) -}}

{{- partial "project-metrics/table.html" (dict
  "prevMonth" $prevMonth
  "currentMonth" $currentMonth
  "prevUniqueVisitors" $prevUniqueVisitors
  "currentUniqueVisitors" $currentUniqueVisitors
  "uniqueVisitorsChange" $uniqueVisitorsChange
  "uniqueVisitorsPercent" $uniqueVisitorsPercent
  "prevPreOrders" $prevPreOrders
  "currentPreOrders" $currentPreOrders
  "preOrdersChange" $preOrdersChange
  "preOrdersPercent" $preOrdersPercent
  "prevConsulting" $prevConsulting
  "currentConsulting" $currentConsulting
  "consultingChange" $consultingChange
  "consultingPercent" $consultingPercent
  "prevSponsors" $prevSponsors
  "currentSponsors" $currentSponsors
  "sponsorsChange" $sponsorsChange
  "sponsorsPercent" $sponsorsPercent
  "prevTotal" $prevTotal
  "currentTotal" $currentTotal
  "totalChange" $totalChange
  "totalPercent" $totalPercent
) -}}
