{{- $project := .Get "project" -}}

{{- /* Extract year and month from page URL */ -}}
{{- $permalink := .Page.RelPermalink -}}
{{- /* Expected format: /retrospectives/YYYY/MM/ */ -}}
{{- $pathParts := split $permalink "/" -}}
{{- $year := "" -}}
{{- $month := "" -}}

{{- /* Find retrospectives, year, and month in the path */ -}}
{{- range $i, $part := $pathParts -}}
  {{- if eq $part "retrospectives" -}}
    {{- if gt (len $pathParts) (add $i 2) -}}
      {{- $year = index $pathParts (add $i 1) -}}
      {{- $month = index $pathParts (add $i 2) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* Early return: Check if year and month were extracted */ -}}
{{- if not (and $year $month) -}}
  {{- errorf
    "Could not extract year and month from URL: %s. Expected format: /retrospectives/YYYY/MM/. Path parts: %s"
    $permalink
    $pathParts
  -}}
{{- end -}}

{{- /* Early return: Validate year and month format */ -}}
{{- $yearInt := int $year -}}
{{- $monthInt := int (strings.TrimLeft "0" $month) -}}
{{- if not (and
  (ge $yearInt 2000)
  (le $yearInt 3000)
  (ge $monthInt 1)
  (le $monthInt 12)
) -}}
  {{- errorf
    "Invalid year (%s) or month (%s) extracted from URL: %s. Year must be 2000-3000, month must be 1-12."
    $year
    $month
    $permalink
  -}}
{{- end -}}

{{- /* Create a time object for the retrospective date and calculate previous months using Go's time functions */ -}}
{{- $retroDate := time (printf "%d-%02d-01" $yearInt $monthInt) -}}
{{- $currentDate := $retroDate.AddDate 0 -1 0 -}}
{{- $prevDate := $retroDate.AddDate 0 -2 0 -}}
{{- $current := $currentDate.Format "2006-01" -}}
{{- $prev := $prevDate.Format "2006-01" -}}

{{- $data := index .Site.Data "project_metrics" -}}
{{- $projectData := index $data $project -}}
{{- $prevData := index $projectData $prev -}}
{{- $currentData := index $projectData $current -}}

{{- /* Early return: Check if data exists for both months */ -}}
{{- if not (and $prevData $currentData) -}}
  {{- errorf
    "Could not find data for project \"%s\" with months \"%s\" and \"%s\". Available data: %s"
    $project
    $prev
    $current
    $projectData
  -}}
{{- end -}}

{{- /* Calculate unique visitors values */ -}}
{{- $prevUniqueVisitors := $prevData.unique_visitors | default 0 | int -}}
{{- $currentUniqueVisitors := $currentData.unique_visitors | default 0 | int -}}

{{- /* Calculate revenue values */ -}}
{{- $prevPreOrders := $prevData.revenue_pre_orders | default 0.0 | float -}}
{{- $prevConsulting := $prevData.revenue_consulting | default 0.0 | float -}}
{{- $prevSponsors := $prevData.revenue_sponsors | default 0.0 | float -}}
{{- $prevTotal := add (add $prevPreOrders $prevConsulting) $prevSponsors -}}

{{- $currentPreOrders := $currentData.revenue_pre_orders | default 0.0 | float -}}
{{- $currentConsulting := $currentData.revenue_consulting | default 0.0 | float -}}
{{- $currentSponsors := $currentData.revenue_sponsors | default 0.0 | float -}}
{{- $currentTotal := add (add $currentPreOrders $currentConsulting) $currentSponsors -}}

{{- /* Calculate changes */ -}}
{{- $uniqueVisitorsChange := sub $currentUniqueVisitors $prevUniqueVisitors -}}
{{- $preOrdersChange := sub $currentPreOrders $prevPreOrders -}}
{{- $consultingChange := sub $currentConsulting $prevConsulting -}}
{{- $sponsorsChange := sub $currentSponsors $prevSponsors -}}
{{- $totalChange := sub $currentTotal $prevTotal -}}

{{- /* Calculate percentage changes */ -}}
{{- $uniqueVisitorsPercent := 0.0 -}}
{{- if gt $prevUniqueVisitors 0 -}}
  {{- $uniqueVisitorsPercent = div
    (mul (float $uniqueVisitorsChange) 100.0)
    (float $prevUniqueVisitors)
  -}}
{{- end -}}

{{- $preOrdersPercent := 0.0 -}}
{{- if gt $prevPreOrders 0 -}}
  {{- $preOrdersPercent = div (mul $preOrdersChange 100) $prevPreOrders -}}
{{- end -}}

{{- $consultingPercent := 0.0 -}}
{{- if gt $prevConsulting 0 -}}
  {{- $consultingPercent = div (mul $consultingChange 100) $prevConsulting -}}
{{- end -}}

{{- $sponsorsPercent := 0.0 -}}
{{- if gt $prevSponsors 0 -}}
  {{- $sponsorsPercent = div (mul $sponsorsChange 100) $prevSponsors -}}
{{- end -}}

{{- $totalPercent := 0.0 -}}
{{- if gt $prevTotal 0 -}}
  {{- $totalPercent = div (mul $totalChange 100) $prevTotal -}}
{{- end -}}

{{- /* Prepare table rows to avoid duplicating rendering logic */ -}}
{{- $metricRows := slice
  (dict
    "label" "Unique visitors"
    "prev" $prevUniqueVisitors
    "current" $currentUniqueVisitors
    "change" $uniqueVisitorsChange
    "percent" $uniqueVisitorsPercent
    "decimals" 0
    "currency" false
    "bold" false
  )
  (dict
    "label" "Revenue from pre-orders"
    "prev" $prevPreOrders
    "current" $currentPreOrders
    "change" $preOrdersChange
    "percent" $preOrdersPercent
    "decimals" 2
    "currency" true
    "bold" false
  )
  (dict
    "label" "Revenue from consulting"
    "prev" $prevConsulting
    "current" $currentConsulting
    "change" $consultingChange
    "percent" $consultingPercent
    "decimals" 2
    "currency" true
    "bold" false
  )
  (dict
    "label" "Revenue from sponsors"
    "prev" $prevSponsors
    "current" $currentSponsors
    "change" $sponsorsChange
    "percent" $sponsorsPercent
    "decimals" 2
    "currency" true
    "bold" false
  )
  (dict
    "label" "Total Revenue"
    "prev" $prevTotal
    "current" $currentTotal
    "change" $totalChange
    "percent" $totalPercent
    "decimals" 2
    "currency" true
    "bold" true
  )
-}}

{{- /* Generate month names using Go's time formatting from the time objects we already created */ -}}
{{- $prevMonth := $prevDate.Format "January 2006" -}}
{{- $currentMonth := $currentDate.Format "January 2006" -}}

{{- /* Prepare data for the chart */ -}}
{{- $chartData := slice -}}
{{- $chartLabels := slice -}}
{{- range $dateKey, $monthData := $projectData -}}
  {{- $dateObj := time (printf "%s-01" $dateKey) -}}
  {{- if le $dateObj $currentDate -}}
    {{- $totalRevenue := add
      (add
        ($monthData.revenue_pre_orders | default 0.0 | float)
        ($monthData.revenue_consulting | default 0.0 | float)
      )
      ($monthData.revenue_sponsors | default 0.0 | float)
    -}}
    {{- $chartData = $chartData | append (dict
      "date" $dateKey
      "visitors" ($monthData.unique_visitors | default 0 | int)
      "revenue" $totalRevenue
    ) -}}
    {{- $chartLabels = $chartLabels | append ($dateObj.Format "Jan 2006") -}}
  {{- end -}}
{{- end -}}

{{- /* Sort the data by date */ -}}
{{- $sortedData := sort $chartData "date" -}}
{{- $sortedLabels := slice -}}
{{- $visitorsData := slice -}}
{{- $revenueData := slice -}}
{{- range $sortedData -}}
  {{- $dateObj := time (printf "%s-01" .date) -}}
  {{- $sortedLabels = $sortedLabels | append ($dateObj.Format "Jan 2006") -}}
  {{- $visitorsData = $visitorsData | append .visitors -}}
  {{- $revenueData = $revenueData | append .revenue -}}
{{- end -}}

<div class="project-metrics-chart" style="margin-bottom: 2rem; height: 400px;">
  <canvas id="{{ $project }}-metrics-chart"
          data-labels="{{ $sortedLabels | jsonify }}"
          data-visitors="{{ $visitorsData | jsonify }}"
          data-revenue="{{ $revenueData | jsonify }}"></canvas>
</div>

<script>
(function() {
  const ctx = document.getElementById('{{ $project }}-metrics-chart');
  if (!ctx) return;

  const labels = JSON.parse(ctx.dataset.labels);
  const visitorsData = JSON.parse(ctx.dataset.visitors);
  const revenueData = JSON.parse(ctx.dataset.revenue);

  const dollarFormat = new Intl.NumberFormat("en-US", {
    style: "currency",
    currency: "USD",
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  });

  const visitorFormat = new Intl.NumberFormat("en-US");

  new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Unique Visitors',
        data: visitorsData,
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        yAxisID: 'y-axis-1',
        fill: false,
        lineTension: 0
      }, {
        label: 'Total Revenue',
        data: revenueData,
        borderColor: '#10b981',
        backgroundColor: 'rgba(16, 185, 129, 0.1)',
        yAxisID: 'y-axis-2',
        fill: false,
        lineTension: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      title: {
        display: true,
        text: 'Project Metrics Over Time'
      },
      tooltips: {
        mode: 'index',
        intersect: false,
        callbacks: {
          label: function(tooltipItem, data) {
            const label = data.datasets[tooltipItem.datasetIndex].label || '';
            if (label === 'Unique Visitors') {
              return label + ': ' + visitorFormat.format(tooltipItem.yLabel);
            } else {
              return label + ': ' + dollarFormat.format(tooltipItem.yLabel);
            }
          }
        }
      },
      scales: {
        xAxes: [{
          display: true,
          scaleLabel: {
            display: true,
            labelString: 'Month'
          }
        }],
        yAxes: [{
          id: 'y-axis-1',
          type: 'linear',
          display: true,
          position: 'left',
          scaleLabel: {
            display: true,
            labelString: 'Unique Visitors'
          },
          ticks: {
            callback: function(value) {
              return visitorFormat.format(value);
            }
          }
        }, {
          id: 'y-axis-2',
          type: 'linear',
          display: true,
          position: 'right',
          scaleLabel: {
            display: true,
            labelString: 'Total Revenue'
          },
          gridLines: {
            drawOnChartArea: false,
          },
          ticks: {
            callback: function(value) {
              return dollarFormat.format(value);
            }
          }
        }]
      }
    }
  });
})();
</script>

<table>
  <thead>
    <tr>
      <th>Metric</th>
      <th>{{ $prevMonth }}</th>
      <th>{{ $currentMonth }}</th>
      <th>Change</th>
    </tr>
  </thead>
  <tbody>
    {{- range $row := $metricRows -}}
      <tr{{ if $row.bold }} style="font-weight: bold;"{{ end }}>
        <td>{{ $row.label }}</td>
        <td>
          {{- if $row.currency -}}
            ${{ $row.prev | lang.FormatNumber $row.decimals }}
          {{- else -}}
            {{ $row.prev | lang.FormatNumber $row.decimals }}
          {{- end -}}
        </td>
        <td>
          {{- if $row.currency -}}
            ${{ $row.current | lang.FormatNumber $row.decimals }}
          {{- else -}}
            {{ $row.current | lang.FormatNumber $row.decimals }}
          {{- end -}}
        </td>
        <td>
          {{- if gt $row.change 0 -}}
            {{- if le $row.prev 0 -}}
              {{- if $row.currency -}}
                <span style="color: green;">+${{ $row.change | lang.FormatNumber $row.decimals }} (+inf%)</span>
              {{- else -}}
                <span style="color: green;">+{{ $row.change | lang.FormatNumber $row.decimals }} (+inf%)</span>
              {{- end -}}
            {{- else -}}
              {{- if $row.currency -}}
                <span style="color: green;">+${{ $row.change | lang.FormatNumber $row.decimals }} (+{{ printf "%.0f" $row.percent }}%)</span>
              {{- else -}}
                <span style="color: green;">+{{ $row.change | lang.FormatNumber $row.decimals }} (+{{ printf "%.0f" $row.percent }}%)</span>
              {{- end -}}
            {{- end -}}
          {{- else if lt $row.change 0 -}}
            {{- if $row.currency -}}
              <span style="color: red;">-${{ (mul $row.change -1) | lang.FormatNumber $row.decimals }} ({{ printf "%.0f" $row.percent }}%)</span>
            {{- else -}}
              <span style="color: red;">{{ $row.change | lang.FormatNumber $row.decimals }} ({{ printf "%.0f" $row.percent }}%)</span>
            {{- end -}}
          {{- else -}}
            {{- if $row.currency -}}
              $0.00 (0%)
            {{- else -}}
              0 (0%)
            {{- end -}}
          {{- end -}}
        </td>
      </tr>
    {{- end -}}
  </tbody>
</table>
