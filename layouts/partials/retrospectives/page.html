<section class="container page retrospective">
  <article>
    <header>
      <h1>{{ .Title }}</h1>
      <div class="post-meta">
        <div class="date">
          <span class="posted-on">
            <i class="fas fa-calendar"></i>
            <time datetime='{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}'>
              {{ .Date.Format (.Site.Params.dateFormat | default "January 2, 2006" ) }}
            </time>
          </span>
          <span class="reading-time">
            <i class="fas fa-clock"></i>
              {{ .ReadingTime }}-minute read
          </span>
        </div>
      </div>
      {{ partial "prev-next.html" . }}
    </header>

    {{ if not (hasPrefix .Title "Notes from") }}
    <h2>One-Line Summary</h2>

    {{ .Params.description }}
    {{ end }}

    {{- with .Content -}}
    <div>
      {{ . | replaceRE "(<h[1-9] id=\"([^\"]+)\".+)(</h[1-9]+>)" `${1}<a href="#${2}" class="hanchor" ariaLabel="Anchor"> ðŸ”—&#xFE0E;</a> ${3}` | safeHTML }}
    </div>
    {{- end -}}

    <hr/>

    {{ partial "prev-next.html" . }}

    {{ partial "mailing-list-signup.html" . }}

    {{ if not .Site.IsServer }}
      {{ partial "talkyard.html" . }}
    {{ end }}
  </article>
</section>

<script src="/js/chart.js/2.9.4/Chart.min.js"></script>
<script>
const dollarFormatter = new Intl.NumberFormat('en-US', {
  style: 'currency',
  currency: 'USD',
  minimumFractionDigits: 0,
  maximumFractionDigits: 0,
});
function drawChart(chartId, labels, data, label, formatter=dollarFormatter.format) {
  const ctx = document.getElementById(chartId);
  if (!ctx) {
    return;
  }
  ctx.height = 300;
  const profitRaw = [3636.08, 10328.80, -352.77, 843.56, 6858.72, -9452.32, -9713.34, -10140.95, 11713.04, 1936.22, 12758.39, -15207.05, -8425.67, 27039.62, -2551.26];
  let profitAvg = [null, null, null, null, null, null, null];
  let trailing = [];
  for (const p of profitRaw) {
    trailing.push(p);
    if (trailing.length > 3) {
      trailing.shift();
    }
    profitAvg.push(trailing.reduce((a, b) => a + b) / trailing.length)
  }
  console.log(profitAvg)
  const myChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: label,
            data: data,
            backgroundColor: '#047a15',
            borderColor: '#4ba658',
            fill: false,
            lineTension: 0.0,
          },
          {
            label: "Profit (3-month trailing average)",
            data: profitAvg,
            backgroundColor: 'black',
            borderColor: 'black',
            fill: false,
            lineTension: .60,
          },
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        tooltips: {
          callbacks: {
            label: function(tooltipItems) {
              return formatter(parseFloat(tooltipItems.yLabel));
            },
          },
        },
        scales: {
              yAxes: [{
                  ticks: {
                    suggestedMin: 0,
                      callback: function(value) {
                          return formatter(value);
                      }
                  }
              }]
          }
      },
  });
}
// Parse a date string like "2020-05" into a JavaScript Date object.
function parseDate(d) {
  const dateParts = d.split('-');
  const year = parseInt(dateParts[0]);
  const month = parseInt(dateParts[1]) - 1;
  return new Date(year, month);
}
function drawCharts(limit) {
  fetch('/data/project-revenue.json')
    .then(res => res.json())
    .then(revenueByProject => {
      const limitDate = parseDate(limit);
      for ([project, data] of Object.entries(revenueByProject)) {
        if (project !== 'tinypilot') {
          continue;
        }
        let dates = [];
        for (d of Object.keys(data)) {
          const date = parseDate(d);
          if (date >= limitDate) {
            continue;
          }
          dates.push(date.toLocaleString('default', { month: 'long' }) + ' ' + date.getFullYear());
        }
        let values = Object.values(data).slice(0, dates.length);
        console.log(project)
        console.log(values)
        drawChart(project + '-revenue', dates, values, 'Total Revenue');
      }
    });
}
drawCharts({{ .Date.Format "2006-01" }});
</script>
