{% comment %}
<!--
  Files Embed Include

  This include file makes it possible to easily embed a file from the
  "files" collection within a page, post, or layout. The file will be
  displayed inside a pre block and include a download link underneath.

  @param {string} "title" - the yml meta field for title in the download file
  @param {string} "language" - the coding language used for syntax highlighting

-->
{% endcomment %}

{% comment %}
<!-- determine correct collection based on language param -->
{% endcomment %}
{% if include.language == "yml" or include.language == "yaml" %}
  {% assign files = site.ymls | where: 'title', include.title %}
{% else %}
  {% assign files = site.files | where: 'title', include.title %}
{% endif %}

{% comment %}
<!-- determine syntax highlighting language.  Defaults to null -->
{% endcomment %}
{% assign lang_highlight = "" %}
{% if include.language %}
  {% assign lang_highlight = include.language %}
{% endif %}

{% comment %}
<!-- initialize file count -->
{% endcomment %}
{% assign file_count = 0 %}

{% comment %}
<!-- initialize an empty string to store unique file paths that match the
  correct file path and title. -->
{% endcomment %}
{% assign found_files = "" %}

{% for file in files %}

  {% comment %}
  <!-- determine correct collection based on language param -->
  {% endcomment %}
  {% assign file_path = file.relative_path  | remove: '_files/'  | remove: '_ymls/' %}
  {% if include.language == "yml" or include.language == "yaml" %}
    {% assign file_path = file_path | append: "." | append: include.language %}
  {% endif %}
  {% assign link = site.baseurl | append: '/files/' | append: file_path %}

  {% comment %}
  <!-- determine file's subdirectory to compare to post subdirectory -->
  {% endcomment %}
  {% assign subdir_array = file.path | split: '/' %}
  {% assign subdir = subdir_array[1] %}

  {% if subdir == page.slug %}

    {% comment %}
    <!-- check to see if any files have been stored (or found) yet.  If string
      is empty, set it to the current file's path. -->
    {% endcomment %}
    {% if found_files == "" %}
      {% assign found_files = file_path %}

```{{ lang_highlight }}
{{ file.content -}}
```
{:.code-block-tab}

<div class="clearfix">
  <a href="{{ link }}" download class="btn--small code-tab">download raw</a>
</div>
    
    {% else %}
    
      {% comment %}
      <!-- split the found files string into an array and check each entry to
        see if it is a duplicate of current file.  If it is not a duplicate,
        then append to the found_files string.  If it is a dupilcate (due to
        Jekyll admin bug or a different reason) then ignore. -->
      {% endcomment %}
      {% assign already_found = "" %}
      {% assign found_file_array = found_files | split: ',' %}
      {% for found_file in found_file_array %}
        {% if found_file != file_path %}
          {% assign already_found = file_path %}
        {% endif %}
      {% endfor %}
      {% if already_found != "" %}
        {% assign found_files = found_files | append: "," | append: already_found %}
      {% endif %}

    {% endif %}
  {% endif %}

{% endfor %}

{% comment %}
<!-- get the size of the array for error trapping below.  A count of 1 is good.
  A count of 0 obviously means no files were found and to raise an exception.
  Any other value should be raised as an exception as that means duplicate
  titles were found for a file in the same directory. -->
{% endcomment %}
{% assign file_count = found_files | split: ',' | size %}

{% unless file_count == 1 %}
  {% if file_count == 0 %}
    {% comment %}
    <!-- if there have been NO files found in the subdirectory that match the
         title, then raise an error -->
    {% endcomment %}
    {{ "Zero file includes matched the title, "
      | append: include.title
      | append: ".  Please check the file include's title and directory again."
      | raise_exception: "warning" }}
  {% else %}
    {% comment %}
    <!-- if there have been more than 1 file with the same title found, then 
         raise an error as this is likely not intentional -->
    {% endcomment %}
    {{ "Multiple file includes with the same title, "
      | append: include.title
      | append: ", have been found."
      | raise_exception: "warning" }}
  {% endif %}
{% endunless %}
