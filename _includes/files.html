{% comment %}
  Files Embed Include

  This include file makes it possible to easily embed a file from the "files"
  collection within a page, post, or layout. The file will be displayed inside
  a pre block and include a download link underneath.

  @param {string} "title" - the yml meta field for title in the download file
  @param {string} "language" - the coding language used for syntax highlighting
{% endcomment %}

{% comment %}
  Determine correct collection based on language param.
{% endcomment %}
{% if include.language == "yml" or include.language == "yaml" %}
	{% assign files = site.ymls | where: 'title', include.title %}
{% else %}
	{% assign files = site.files | where: 'title', include.title %}
{% endif %}

{% comment %}
  Determine syntax highlighting language (defaults to null).
{% endcomment %}
{% assign lang_highlight = "" %}
{% if include.language %}
	{% assign lang_highlight = include.language %}
{% endif %}

{% comment %} 
  Initialize an empty string to store unique file paths that match the correct
  file path and title.
{% endcomment %}
{% assign found_files = "" %}

{% for file in files %}

  {% comment %}
    Determine which page includes this file. It will match the name of the
    folder that contains the file, for example:

      _files/sia-nextcloud/Dockerfile.sia
             ^^^^^^^^^^^^^
             Matching page slug
  {% endcomment %}
  {% assign file_path_parts = file.relative_path | split: '/' %}
  {% assign matching_page_slug = file_path_parts[1] %}

  {% comment %}
    If we're not in the page that includes this file, skip it.
  {% endcomment %}
  {% if matching_page_slug != page.slug %}
    {% continue %}
  {% endif %}

  {% comment %}
    Determine the relative URL of the file as it will appear on the site.
  {% endcomment %}
  {% assign file_relative_url = file.relative_path | replace: '_files/', '/files/' | replace: '_ymls/', '/files/' %}
  {% comment %}
    YAML files are a special case because the files are not stored with their
    extensions. We need to add the extensions back, so a URL like:

      /files/sia-nextcloud/docker-compose

    becomes:

      /files/sia-nextcloud/docker-compose.yml

    Note that we must normalize the extension to .yml, even if the language is
    set to "yaml" because the embed will fail if it's "yaml".
  {% endcomment %}
  {% if include.language == 'yml' or include.language == 'yaml' %}
    {% assign file_relative_url = file_relative_url | append: '.yml' %}
  {% endif %}

  {% comment %}
    Check to see if any files have been stored (or found) yet.  If string is
    empty, that means we can embed the file.  Otherwise, it's a duplicate.
  {% endcomment %}
  {% if found_files == "" %}

```{{ lang_highlight }}
{{ file.content -}}
```
{:.code-block-tab}

<div class="clearfix">
  <a href="{{ file_relative_url }}" download class="btn--small code-tab">download raw</a>
</div>
  {% endif %}

  {% comment %}
    Concatenate the relative URL to the string for use in error trapping below.
  {% endcomment %}
  {% assign found_files = found_files | append: file_relative_url | append: "," %}
{% endfor %}

{% comment %}
  Determine the number of unique matching files found.
{% endcomment %}
{% assign file_count = found_files | split: "," | uniq | size %}

{% comment %}
  Sanity check the file_count. If the file count is:

  1: This is the expected case. We found a single file match for the file
     specified in the markdown. Do nothing because we've already rendered the
     file embed.
  0: We didn't find a matching file. Raise a warning to indicate that the file
     include didn't match any files. This could indicate that the markdown
     specified the wrong file or that the file hasn't been uploaded to the
     server yet.
  >1: Multiple files matched. This can happen when more than 1 file in the
     page's folder has identical "title:" yml frontmatter values.
{% endcomment %}
{% if file_count == 1 %}
  {% comment %} Found exactly one file. No exception. {% endcomment %}
{% elsif file_count == 0 %}
  {% comment %}
    If zero files were found in the page's folder that match the file embed
    title, then raise an error.
  {% endcomment %}
  {{ "Zero file includes matched the title, "
    | append: include.title
    | append: ".  Please check the file include's title and directory again."
    | raise_exception: "warning" }}
{% elsif file_count > 1 %}
  {% comment %}
    If more than 1 file were found in the page's folder that match the file
    embed title, then raise an error as this is likely not intentional.
  {% endcomment %}
  {{ "Multiple file includes with the same title, "
    | append: include.title
    | append: ", have been found."
    | raise_exception: "warning" }}
{% else %}
  {% comment %} An unknown exception occurred. {% endcomment %}
  {{ "An unknown exception has occurred on, "
    | append: include.title
    | raise_exception: "warning" }}
{% endif %}
