{% comment %}
  Files Embed Include

  This include file makes it possible to easily embed a file from the "files"
  collection within a page, post, or layout. The file will be displayed inside
  a pre block and include a download link underneath.

  @param {string} "title" - the yml meta field for title in the download file
  @param {string} "language" - the coding language used for syntax highlighting
{% endcomment %}

{% comment %}
  Determine correct collection based on language param.
{% endcomment %}
{% if include.language == "yml" or include.language == "yaml" %}
	{% assign files = site.ymls | where: 'title', include.title %}
{% else %}
	{% assign files = site.files | where: 'title', include.title %}
{% endif %}

{% comment %}
  Determine syntax highlighting language (defaults to null).
{% endcomment %}
{% assign lang_highlight = "" %}
{% if include.language %}
	{% assign lang_highlight = include.language %}
{% endif %}

{% comment %} Initialize file count. {% endcomment %}
{% assign file_count = 0 %}

{% comment %} 
  Initialize an empty string to store unique file paths that match the correct
  file path and title.
{% endcomment %}
{% assign found_files = "" %}

{% for file in files %}

  {% comment %}
    Determine which page includes this file. It will match the name of the
    folder that contains the file, for example:

      _files/sia-nextcloud/Dockerfile.sia
             ^^^^^^^^^^^^^
             Matching page slug
  {% endcomment %}
  {% assign file_path_parts = file.relative_path | split: '/' %}
  {% assign matching_page_slug = file_path_parts[1] %}

  {% comment %}
    If we're not in the page that includes this file, skip it.
  {% endcomment %}
  {% if matching_page_slug != page.slug %}
    {% continue %}
  {% endif %}

  {% comment %}
    Determine the relative URL of the file as it will appear on the site.
  {% endcomment %}
  {% assign file_relative_url = file.relative_path | replace: '_files/', '/files/' | replace: '_ymls/', '/files/' %}
  {% comment %}
    YAML files are a special case because the files are not stored with their
    extensions. We need to add the extensions back, so a URL like:

      /files/sia-nextcloud/docker-compose

    becomes:

      /files/sia-nextcloud/docker-compose.yml

    Note that we must normalize the extension to .yml, even if the language is
    set to "yaml" because the embed will fail if it's "yaml".
  {% endcomment %}
  {% if include.language == 'yml' or include.language == 'yaml' %}
    {% assign file_relative_url = file_relative_url | append: '.yml' %}
  {% endif %}

  {% comment %}
    Check to see if any files have been stored (or found) yet.  If string is
    empty, set it to the current file's path.
  {% endcomment %}
  {% if found_files == "" %}
    {% assign found_files = file_relative_url %}

```{{ lang_highlight }}
{{ file.content -}}
```
{:.code-block-tab}

<div class="clearfix">
  <a href="{{ file_relative_url }}" download class="btn--small code-tab">download raw</a>
</div>

  {% else %}
    {% comment %}
      Split the found files string into an array and check each entry to
      see if it is a duplicate of current file.  If it is not a duplicate,
      then append to the found_files string.  If it is a dupilcate (due to
      Jekyll admin bug or a different reason) then ignore.
    {% endcomment %}
    {% assign already_found = "" %}
    {% assign found_file_array = found_files | split: ',' %}
    {% for found_file in found_file_array %}
      {% if found_file != file_relative_url %}
        {% assign already_found = file_relative_url %}
      {% endif %}
    {% endfor %}
    {% if already_found != "" %}
      {% assign found_files = found_files | append: "," | append: already_found %}
    {% endif %}
  {% endif %}

{% endfor %}

{% comment %}
  Determine how many unique files were found for the file embed.  The below
  table describes the possible scenarios based on the size of the "found_files"
  string after it is split into an array:

  Size of Array | Error Thrown? | Description
  -------------------------------------------
        0       |     Yes       | No matching files were found to embed.
        1       |     No        | Exactly 1 file was found which is expected.
        >1      |     Yes       | Duplicate titles found.
{% endcomment %}

{% comment %} Break string into array for error trapping. {% endcomment %}
{% assign file_count = found_files | split: ',' | size %}

{% unless file_count == 1 %}
  {% if file_count == 0 %}
    {% comment %}
      If zero files were found in the page's folder that match the file embed
      title, then raise an error.
    {% endcomment %}
    {{ "Zero file includes matched the title, "
      | append: include.title
      | append: ".  Please check the file include's title and directory again."
      | raise_exception: "warning" }}
  {% else %}
    {% comment %}
      If more than 1 file were found in the page's folder that match the file
      embed title, then raise an error as this is likely not intentional.
    {% endcomment %}
    {{ "Multiple file includes with the same title, "
      | append: include.title
      | append: ", have been found."
      | raise_exception: "warning" }}
  {% endif %}
{% endunless %}
